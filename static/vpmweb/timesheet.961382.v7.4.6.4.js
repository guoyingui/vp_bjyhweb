webpackJsonp([5],{877:function(e,t,a){"use strict";function l(e){return e&&e.__esModule?e:{"default":e}}function n(e,t){var a=new Date(Date.parse(e.replace(/-/g,"/")));a.setDate(a.getDate()+t);var l=a.getMonth()+1;return a.getFullYear()+"-"+l+"-"+a.getDate()}Object.defineProperty(t,"__esModule",{value:!0});var i=a(786),r=l(i),s=a(688),c=l(s),o=a(54),d=l(o),u=a(55),m=l(u),p=a(59),f=l(p),h=a(93),v=l(h),g=a(8),y=l(g),E=a(4),b=a(652);a(878),Date.prototype.Format=function(e){var t={"M+":this.getMonth()+1,"d+":this.getDate(),"h+":this.getHours(),"m+":this.getMinutes(),"s+":this.getSeconds(),"q+":Math.floor((this.getMonth()+3)/3),S:this.getMilliseconds()};/(y+)/.test(e)&&(e=e.replace(RegExp.$1,(this.getFullYear()+"").substr(4-RegExp.$1.length)));for(var a in t)new RegExp("("+a+")").test(e)&&(e=e.replace(RegExp.$1,1==RegExp.$1.length?t[a]:("00"+t[a]).substr((""+t[a]).length)));return e};var D=function(e){function t(e){(0,d["default"])(this,t);var a=(0,f["default"])(this,(t.__proto__||(0,c["default"])(t)).call(this,e));return a.listProject=function(){(0,E.vpQuery)("/{vpmprovider}/timesheet/listProject",{}).then(function(e){a.setState({listProject:e.data})})},a.getWorkHours=function(e){(0,E.vpQuery)("/{vpmprovider}/timesheet/getWorkHours",{selectdate:e}).then(function(e){var t=e.data;a.setState({ybgsMonth:t.month.ybgsMonth,okMonth:t.month.okMonth,noMonth:t.month.noMonth,ybgsWeek:t.week.ybgsWeek,okWeek:t.week.okWeek,noWeek:t.week.noWeek,ybgsDay:t.days.ybgsDay,okDay:t.days.okDay,noDay:t.days.noDay,overTimeDay:t.days.overTimeDay})})},a.handleSelectChange=function(e){a.setState({projectid:e,tableData:[],data:[],tableHeader:[]},function(){a.queryTimeSheetHeader(),a.queryTimeSheetData()})},a.queryTimeSheetHeader=function(){(0,E.vpQuery)("/{vpmprovider}/timesheet/getheader",{projectid:a.state.projectid}).then(function(e){var t=[];e.data.headers.fields.map(function(e,l){"sname"==e.field_name?t.push({title:e.field_label,dataIndex:e.field_name,fixed:e.fixed,width:250,edit_col:e.edit_col,widget:e.widget,render:function(t,l){return y["default"].createElement(E.VpRow,null,1==l.isubmitstate&&2!=l.iapprovalstate||-2==a.state.projectid||0==l.itasktype?"":y["default"].createElement(E.VpCol,{span:2,className:"delete-icon"},y["default"].createElement(E.VpTooltip,{placement:"top",title:"删除"},y["default"].createElement(E.VpPopconfirm,{title:"确定要删除这条信息吗？",onConfirm:function(){return a.confirm(l.iid)},onCancel:a.cancel},y["default"].createElement(E.VpIcon,{className:"text-danger cursor",type:"minus-circle"})))),y["default"].createElement(E.VpCol,{span:22,className:"add-row"},y["default"].createElement(b.EditTableCol,{flag:1==l.isubmitstate&&2!=l.iapprovalstate||-2==a.state.projectid||0==l.itasktype,callBack:a.callBack,record:l,widget:e.widget,value:t})))}}):"iapprovalstate"==e.field_name?t.push({title:e.field_label,dataIndex:e.field_name,fixed:e.fixed,width:50,edit_col:e.edit_col,widget:e.widget,render:function(e,t){var a=void 0,l=void 0,n="text-muted";switch(t.iapprovalstate){case"0":a="clock-circle-o",l="待审批";break;case"1":a="check-circle",n="text-info",l="已审批";break;case"2":a="cross-circle",n="text-danger",l="已拒绝";break;default:a="clock-circle-o",l="待审批"}return y["default"].createElement(E.VpTooltip,{placement:"top",title:l},y["default"].createElement(E.VpIcon,{className:"cursor m-lr-xs f16 "+n,type:a}))}}):t.push({title:e.field_label,dataIndex:e.field_name,fixed:e.fixed,width:150,edit_col:e.edit_col,widget:e.widget,render:e.edit_col?function(t,l){var n=!1;return n="select"==e.widget.widget_type?1==l.isubmitstate&&2!=l.iapprovalstate||-2==a.state.projectid:1==l.isubmitstate&&2!=l.iapprovalstate,e.field_name,y["default"].createElement(b.EditTableCol,{flag:n,callBack:a.callBack,record:l,widget:e.widget,value:t})}:null})}),a.setState({tableHeader:t})})},a.queryTimeSheetData=function(){var e=a.state,t=e.projectid,l=e.cDate;(0,E.vpQuery)("/{vpmprovider}/timesheet/listtimesheet",{projectid:t,date:l}).then(function(e){a.setState({tableData:e.data.list,allData:e.data.list},function(){vp.computedHeight(e.data.list.length,null,420)})})},a.getAllData=function(e){a.setState({loading:!0});var t=[],l=a.state.allData,n=[];l.map(function(e,t){var a=!1,l=e.iid;n.map(function(e,t){var n=e.iid;l==n&&(a=!0)}),0==a&&n.push(e)}),n.map(function(e,a){e.iid;/^[\u3220-\uFA29]+$/.test(e.iactivityid)&&(e.iactivityid=e.iactivityidval),delete e.iactivityidval,""==e.ipercent&&(e.ipercent="0"),""==e.imanhour&&(e.imanhour="0"),""==e.imanovertime&&(e.imanovertime="0"),t.push(e)}),a.validateTimeSheet(t,e)},a.validateTimeSheet=function(e,t){var l=a.state.ybgsDay,n=a.state,i=n.cDate,r=n.projectid,s=0,c=0;e.filter(function(e){return"2"!=e.iapprovalstate}).map(function(e,t){s+=parseFloat(e.imanovertime),""==e.imanhour?c+=0:c+=parseFloat(e.imanhour),""==e.imanovertime?s+=0:s+=parseFloat(e.imanovertime)}),(0,E.vpQuery)("/{vpmprovider}/timesheet/getworkload",{date:i,projectid:r}).then(function(n){if(s+=parseFloat(n.data.imanovertime),(c+=parseFloat(n.data.imanhour))>parseFloat(l)){var i="每天正常工时不能超过"+l+"小时";0==l&&(i="应报正常工时为0，请报加班工时！"),(0,E.VpAlertMsg)({message:"消息提示",description:i,type:"error",closeText:"关闭",showIcon:!0},5),a.setState({loading:!1})}else s+c>24?((0,E.VpAlertMsg)({message:"消息提示",description:"每天上班时长不能超过24小时！",type:"error",closeText:"关闭",showIcon:!0},5),a.setState({loading:!1})):a.handleSubmit(e,t)})},a.handleSubmit=function(e,t){var l=e.filter(function(e){return(0==e.isubmitstate||2==e.iapprovalstate)&&""!=e.sname});if(l.length){var n=$("#textarea").val(),i=a.state,s=i.cDate,c=i.projectid;(0,E.vpAdd)("/{vpmprovider}/timesheet/save",{timesheetdata:(0,r["default"])(l),date:s,projectid:c,sremark:n,flag:t}).then(function(e){"save"==t?(0,E.VpAlertMsg)({message:"消息提示",description:"保存成功！",type:"success",closeText:"关闭",showIcon:!0},5):(0,E.VpAlertMsg)({message:"消息提示",description:"提交成功！",type:"success",closeText:"关闭",showIcon:!0},5),a.setState({tableHeader:[],tableData:[],data:[],loading:!1},function(){a.getWorkHours(),a.queryTimeSheetHeader(),a.queryTimeSheetData()})})["catch"](function(e){a.setState({loading:!1})})}else(0,E.VpAlertMsg)({message:"消息提示",description:"暂无可提交的报工！",type:"error",closeText:"关闭",showIcon:!0},5),a.setState({loading:!1})},a.confirm=function(e){for(var t=0;t<a.state.tableData.length;t++)a.state.tableData[t].iid==e&&a.state.tableData.splice(t,1);a.setState({tableData:a.state.tableData}),e>0&&(0,E.vpQuery)("/{vpmprovider}/timesheet/delete",{iid:e}).then(function(e){(0,E.VpAlertMsg)({message:"消息提示",description:"删除成功！",type:"success",closeText:"关闭",showIcon:!0},5),a.getWorkHours()})},a.cancel=function(){},a.callBack=function(e){var t=a.state.allData,l=t.filter(function(t){return t.iid!=e.iid});l.push(e),a.state.data.push(e),a.setState({allData:l,data:a.state.data})},a.sliderChange=function(e,t){var l={};l[t]=e,a.setState(l)},a.onDatePickerChange=function(e,t){a.setState({cDate:t},function(){a.getWorkHours(t)})},a.handleAdd=function(){var e=a.state.iid-1,t={iid:e,sname:"",iactivityid:"",iactivityidval:"",ipercent:"0",imanhour:"",imanovertime:"",iapprovalstate:0,rownums:e};t.delete_row=!0,t.isubmitstate=0,t.itasktype=1,a.state.tableData.push(t),a.setState({tableData:a.state.tableData,iid:e},function(){var e=vp.computedHeight(1,null,435);a.setState({maxHeight:e})})},a.onPanelChange=function(e,t){setTimeout(function(){a.init()},0)},a.onSelect=function(e,t){if(t){var l=($(t).children(".ant-fullcalendar-date").children(".ant-fullcalendar-value"),new Date($(t).attr("title").replace(/-/g,"/")).Format("yyyy-MM-dd"));a.setState({selectDate:l,cDate:l},function(){a.listProject(),a.getWorkHours(l),a.queryTimeSheetData()})}},a.init=function(e){(0,E.vpQuery)("/{vpmprovider}/timesheet/alreadyReport",{projectid:a.state.projectid,cDate:a.state.cDate,type:e}).then(function(e){var t=e.data.reportedList,a=e.data.firstday,l=e.data.lastday;$(".ant-fullcalendar-cell").each(function(e,n){var i=$(n).attr("title").replace(/-/g,"/"),r=Date.parse(new Date(i));t.map(function(e,t){var i=Date.parse(new Date(e.dtimesheetdate)),s=e.cmanhour;e.cmanovertime,r>=a&&r<=l?i!=r?$(n).children(".ant-fullcalendar-date").children(".ant-fullcalendar-value").addClass("workday"):s<8?$(n).children(".ant-fullcalendar-date").children(".ant-fullcalendar-value").addClass("workday"):$(n).children(".ant-fullcalendar-date").children(".ant-fullcalendar-value").removeClass("workday"):$(n).children(".ant-fullcalendar-date").children(".ant-fullcalendar-value").removeClass("workday")})}),$("td.ant-fullcalendar-cell:nth-child(6n) .ant-fullcalendar-value").removeClass("workday"),$("td.ant-fullcalendar-cell:nth-child(7n) .ant-fullcalendar-value").removeClass("workday"),$("td.ant-fullcalendar-cell:nth-child(6n) .ant-fullcalendar-value").addClass("holiday"),$("td.ant-fullcalendar-cell:nth-child(7n) .ant-fullcalendar-value").addClass("holiday")})},a.onDateClick=function(e){a.init(e)},a.state={tableHeader:[],tableData:[],filter_data:[],filtervalue:"",data:[],visible:!1,iid:-1,selectDate:[],cDate:(new Date).Format("yyyy-MM-dd"),listProject:[],ybgsMonth:0,ybgsWeek:0,ybgsDay:0,okMonth:0,okWeek:0,okDay:0,noMonth:0,noWeek:0,noDay:0,projectid:-1,allData:[],maxHeight:null,loading:!1},a.changeDate=a.changeDate.bind(a),a}return(0,v["default"])(t,e),(0,m["default"])(t,[{key:"componentWillMount",value:function(){this.queryTimeSheetHeader(),this.listProject(),this.getWorkHours(),this.queryTimeSheetData()}},{key:"componentDidMount",value:function(){}},{key:"changeDate",value:function(e){var t=this,a="",l=this.state.cDate?this.state.cDate:(new Date).Format("yyyy-MM-dd");a="up"==e?n(l,1):n(l,-1),this.setState({cDate:a},function(){t.getWorkHours(a),-1!=t.state.projectid&&t.queryTimeSheetData()})}},{key:"render",value:function(){var e=this;return y["default"].createElement("div",{className:"time-sheet full-height pr",style:{paddingTop:40}},y["default"].createElement("div",{className:"subAssembly b-b bg-white"},y["default"].createElement(E.VpRow,{gutter:10},y["default"].createElement(E.VpCol,{className:"gutter-row pr",span:4},y["default"].createElement("div",{className:"fl date-picker"},y["default"].createElement(E.VpIcon,{type:"up",onClick:function(){return e.changeDate("up")},className:"cursor f12"}),y["default"].createElement(E.VpIcon,{type:"down",onClick:function(){return e.changeDate("down")},className:"cursor f12"})),y["default"].createElement("div",{className:"fr date-picker-input"},y["default"].createElement(E.VpDatePicker,{onChange:this.onDatePickerChange,defaultValue:new Date,value:this.state.cDate}))),y["default"].createElement(E.VpCol,{className:"gutter-row",span:4},y["default"].createElement(E.VpSelect,{showSearch:!0,defaultValue:"-1",placeholder:"所属项目",className:"block",optionFilterProp:"children",notFoundContent:"无法找到",onChange:this.handleSelectChange},y["default"].createElement(E.VpOption,{value:"-1"},"请选择项目"),y["default"].createElement(E.VpOption,{value:"-2"},"日常管理"),this.state.listProject.map(function(e,t){return y["default"].createElement(E.VpOption,{key:t,value:e.iid.toString()},e.sname)}))),y["default"].createElement(E.VpCol,{className:"gutter-row",span:4}),y["default"].createElement(E.VpCol,{className:"gutter-row",span:5}),y["default"].createElement(E.VpCol,{className:"gutter-row text-right text",span:7}))),y["default"].createElement("div",{className:"full-height pr"},y["default"].createElement("div",{className:"table-content bg-white p-sm full-height"},y["default"].createElement(E.VpRow,{className:"sheet-time p-b-sm b-b bg-white"},y["default"].createElement(E.VpCol,{className:"text-center",span:8},y["default"].createElement("div",{className:"m-b-sm fw"},"本月工时"),y["default"].createElement(E.VpRow,null,y["default"].createElement(E.VpCol,{span:8},y["default"].createElement("div",{className:"text-primary f24"},this.state.ybgsMonth),y["default"].createElement("div",{className:"text-muted"},"应报工时")),y["default"].createElement(E.VpCol,{span:8},y["default"].createElement("div",{className:"text-info f24"},this.state.okMonth),y["default"].createElement("div",{className:"text-muted"},"已报工时")),y["default"].createElement(E.VpCol,{span:8,id:"sheet",onClick:function(){return e.onDateClick("month")}},y["default"].createElement(E.VpDropdown,{overlay:y["default"].createElement("div",{className:"sheet-box bg-white"},y["default"].createElement(E.VpCalendar,{fullscreen:!1,ref:function(t){e.VpCalendar=t},onPanelChange:this.onPanelChange,onSelect:this.onSelect,init:function(){return e.init("month")}})),trigger:["click"],getPopupContainer:function(){return document.getElementById("sheet")}},y["default"].createElement("div",{className:"cursor"},y["default"].createElement("div",{className:"text-warning f24"},this.state.noMonth),y["default"].createElement("div",{className:"text-muted"},"未报工时")))))),y["default"].createElement(E.VpCol,{className:"text-center title-week",span:8},y["default"].createElement("div",{className:"m-b-sm fw"},"本周工时"),y["default"].createElement(E.VpRow,null,y["default"].createElement(E.VpCol,{span:8},y["default"].createElement("div",{className:"text-primary f24"},this.state.ybgsWeek),y["default"].createElement("div",{className:"text-muted"},"应报工时")),y["default"].createElement(E.VpCol,{span:8},y["default"].createElement("div",{className:"text-info f24"},this.state.okWeek),y["default"].createElement("div",{className:"text-muted"},"已报工时")),y["default"].createElement(E.VpCol,{span:8,onClick:function(){return e.onDateClick("week")}},y["default"].createElement(E.VpDropdown,{overlay:y["default"].createElement("div",{className:"sheet-box bg-white"},y["default"].createElement(E.VpCalendar,{fullscreen:!1,ref:function(t){e.VpCalendar=t},onPanelChange:this.onPanelChange,onSelect:this.onSelect,init:function(){return e.init("week")}})),trigger:["click"],getPopupContainer:function(){return document.getElementById("sheet")}},y["default"].createElement("div",{className:"cursor"},y["default"].createElement("div",{className:"text-warning f24"},this.state.noWeek),y["default"].createElement("div",{className:"text-muted"},"未报工时")))))),y["default"].createElement(E.VpCol,{className:"text-center",span:8},y["default"].createElement("div",{className:"m-b-sm fw"},"当天工时"),y["default"].createElement(E.VpRow,null,y["default"].createElement(E.VpCol,{span:8},y["default"].createElement("div",{className:"text-primary f24"},this.state.ybgsDay),y["default"].createElement("div",{className:"text-muted"},"应报工时")),y["default"].createElement(E.VpCol,{span:8},y["default"].createElement("div",{className:"text-info f24"},this.state.okDay),y["default"].createElement("div",{className:"text-muted"},"已报工时")),y["default"].createElement(E.VpCol,{span:8,onClick:function(){return e.onDateClick("day")}},y["default"].createElement(E.VpDropdown,{overlay:y["default"].createElement("div",{className:"sheet-box bg-white"},y["default"].createElement(E.VpCalendar,{fullscreen:!1,ref:function(t){e.VpCalendar=t},onPanelChange:this.onPanelChange,onSelect:this.onSelect,init:function(){return e.init("day")}})),trigger:["click"],getPopupContainer:function(){return document.getElementById("sheet")}},y["default"].createElement("div",{className:"cursor"},y["default"].createElement("div",{className:"text-warning f24"},this.state.noDay),y["default"].createElement("div",{className:"text-muted"},"未报工时"))))))),y["default"].createElement("div",{ref:"maxHeight",className:"full-height time-table"},y["default"].createElement(E.VpTable,{columns:this.state.tableHeader,dataSource:this.state.tableData,useFixedHeader:!0,resize:!0,pagination:!1,scroll:{y:this.state.maxHeight},className:"timesheettable"})),y["default"].createElement("div",{className:"bg-white sheet-content"},y["default"].createElement("div",{className:"m-b-sm"},y["default"].createElement("p",{disabled:-2==this.state.projectid||-1==this.state.projectid,className:-2==this.state.projectid||-1==this.state.projectid?"cursor inline-display p-tb-xs":"text-primary cursor inline-display p-tb-xs",onClick:-2==this.state.projectid||-1==this.state.projectid?null:this.handleAdd},y["default"].createElement(E.VpIcon,{type:"plus-circle",className:"m-r-xs"}),"添加报工"),y["default"].createElement(E.VpInput,{placeholder:"请输入工作内容！",id:"textarea",type:"textarea",rows:4})),y["default"].createElement("div",{className:"p-sm text-center"},y["default"].createElement(E.VpButton,{loading:this.state.loading,disabled:-1==this.state.projectid||""==this.state.cDate,className:"m-r-xs vp-btn-br",type:"primary",onClick:function(){return e.getAllData("submit")}},"提交"),y["default"].createElement(E.VpButton,{loading:this.state.loading,disabled:-1==this.state.projectid||""==this.state.cDate,className:"m-r-xs vp-btn-br",onClick:function(){return e.getAllData("save")}},"保存"))))))}}]),t}(y["default"].Component);t["default"]=D},878:function(e,t,a){var l=a(879);"string"==typeof l&&(l=[[e.id,l,""]]);var n={hmr:!0};n.transform=void 0;a(439)(l,n);l.locals&&(e.exports=l.locals)},879:function(e,t){}});