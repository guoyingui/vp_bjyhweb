try{Ext.require(["Gnt.panel.Gantt","Sch.plugin.TreeCellEditing","Gnt.column.PercentDone","Gnt.column.StartDate","Gnt.column.EndDate","Gnt.column.Duration","Gnt.widget.AssignmentCellEditor","Gnt.column.ResourceAssignment","Gnt.model.Assignment"]);function getSigleTask(taskStore,leaf){var date=new Date(2010,1,2);var newM=new taskStore.model({PercentDone:0,Name:"newTask",StartDate:date,EndDate:date,Duration:0,DurationUnit:"d",leaf:leaf,Option2:0,children:[]});newM.childNodes=[];return newM}vpGantt.getNodesList=function(store,ja){var a=[];for(var i=0;i<ja.length;i++){a.push(vpGantt.getSingleElement(store,ja[i]))}return a};vpGantt.getSingleElement=function(store,json){var curHas=(json.children&&json.children.length>0);var curMd=new store.model({WorkLoad:json.WorkLoad,DependencyTask:json.DependencyTask,ResIds:json.ResIds,IndicateLight:json.IndicateLight,Id:json.Id,PercentDone:json.PercentDone,Name:json.Name,StartDate:json.StartDate,EndDate:json.EndDate,Duration:json.Duration,Priority:json.Priority,DurationUnit:"d",Responsible:json.Responsible,BaselineStartDate:json.BaselineStartDate,BaselineEndDate:json.BaselineEndDate,BaselineWorkLoad:json.BaselineWorkLoad,expanded:json.expanded,leaf:!curHas,Option2:json.Option2});curMd.childNodes=[];if(curHas){var cs=[];for(var i=0;i<json.children.length;i++){cs.push(vpGantt.getSingleElement(store,json.children[i]))}curMd.appendChild(cs)}return curMd};function copyTask(c){var curStartDate,curEndDate;curStartDate=c.get("StartDate");curEndDate=new Date(c.get("StartDate").getTime()+(3600*24*1000));var a=new Gnt.model.Task({IndicateLight:"{0}{0}{0}{0}",Id:"T_"+vpGantt.newId,PercentDone:0,BaselineWorkLoad:0,WorkLoad:0,Name:"newTask_"+vpGantt.newId++,StartDate:curStartDate,EndDate:curEndDate,BaselineStartDate:"",BaselineEndDate:"",Duration:1,Option2:0,DurationUnit:(c&&c.get("DurationUnit"))||"d",leaf:true});return a}Ext.define("Task",{extend:"Gnt.model.Task",associations:[{model:"Assignment",name:"assignments",type:"hasMany",primaryKey:"Id",foreignKey:"TaskId",associationKey:"assignments"}]});Ext.define("Assignment",{extend:"Gnt.model.Assignment",belongsTo:"Task"});vpGantt.resourceStore=Ext.create("Ext.data.JsonStore",{model:"Gnt.model.Resource",proxy:{type:"memory",reader:{type:"json"}}});vpGantt.assignmentStore=Ext.create("Ext.data.JsonStore",{model:"Assignment",resourceStore:vpGantt.resourceStore,proxy:{type:"memory",reader:{type:"json"}}});vpGantt.doRollUp=false;vpGantt.isDoRollUp=function(){return this.doRollUp};vpGantt.setDoRollUp=function(){this.doRollUp=arguments[0]};vpGantt.getCalendar=function(){var data,result=[];jQuery.ajax({url:"/project/system/workCalendarAction.do",data:{themethod:"getCalItemsByPID",projectID:vpGantt.getProjectId()},type:"post",async:false,success:function(res){data=res},dataType:"json"});if(data.length>0){for(var i=0;i<data.length;i++){result.push({Date:new Date(data[i].dateL),IsWorkingDay:data[i].isWorkday})}}return new Gnt.data.Calendar({data:result})};vpGantt.taskStore=Ext.create("Gnt.data.TaskStore",{recalculateParents:vpGantt.isDoRollUp(),calendar:vpGantt.getCalendar(),buffered:false,model:"Task",proxy:{type:"memory",reader:{type:"json"}}});vpGantt.getData=function(projectId,taskId){var data;jQuery.ajax({url:"/project/wbs/ganttLoadAction.do",data:{themethod:"loadEditGanttData",projectId:projectId,taskId:taskId},type:"post",async:false,success:function(res){data=res},dataType:"json"});return data};vpGantt.assignmentEditor=Ext.create("Gnt.widget.AssignmentCellEditor",{assignmentStore:vpGantt.assignmentStore,resourceStore:vpGantt.resourceStore});vpGantt.rendeIndicater=function(v,m,r){var lightsStr="",t1=v.charAt(1),t2,t3,t4=v.charAt(10),l1=v.charAt(1),l2=v.charAt(4),l3=v.charAt(7),l4=v.charAt(10);if(l1=="0"){l1="icon_wks.gif"}else{if(l1=="1"){l1="icon_jxz.gif"}else{l1="icon_ywc.gif"}}for(var i=0;i<vpGantt.stateList.length;i++){if(vpGantt.stateList[i].id==t1){t1=vpGantt.stateList[i].value;break}}var flags='<div style="border:0px solid #000;position:relative;width:16px;text-align:center;left:-8px;"><img  src="/project/images/wbstask/'+l1+'" title="'+t1+'" />';if(parseInt(r.get("Option2"))==0){flags+='<img  src="/project/images/wbstask/icon_cjyes.gif" title="可裁剪" />'}else{flags+='<img  src="/project/images/wbstask/icon_cjno.gif" title="不可裁剪" />'}flags+="</div>";return flags};vpGantt.workLoadPrecision=0.01;vpGantt.setWorkLoadPrecision=function(wp){this.workLoadPrecision=wp};vpGantt.getWorkLoadPrecision=function(){return this.workLoadPrecision};vpGantt.getWLByPrecision=function(v){var preBig=(1/this.workLoadPrecision);return Math.round(parseFloat(v)*preBig)/preBig};vpGantt.columns=[{header:"ID",sortable:false,width:40,dataIndex:"Id",menuDisabled:true,renderer:function(v,m,r){return v},locked:true},{header:" ",width:32,dataIndex:"IndicateLight",sortable:false,menuDisabled:true,align:"center",renderer:vpGantt.rendeIndicater},{header:"  ",id:"zs",type:"string",sortable:false,menuDisabled:true,width:20,renderer:function(value,metadata,record,rowIndex){var content='<img style="border:0px solid #000;width:16px;position:relative;left:-4px;" onMouseOver="itemOver(this);"  onMouseOut="itemOut(this);"  onClick="clickOpr(this, '+rowIndex+')" src="/project/vframe/images/other/icon_openlink.gif" />';return content}},{xtype:"treecolumn",dataIndex:"Name",header:"任务名称",sortable:false,menuDisabled:true,align:"left",width:140,field:{allowBlank:false},renderer:function(value,metaData,record,rowIdx,colIdx,store){if(record.get("leaf")){metaData.tdCls="task"}if(record.get("Duration")<vpGantt.getWorkLoadPrecision()){metaData.tdCls="milestone"}if(!record.get("leaf")){metaData.tdCls="abstract-task"}return value}},{header:"工期",xtype:"durationcolumn",dataIndex:"Duration",menuDisabled:true,sortable:false,align:"right",width:50},{header:'<table class="head-table"><tr><td>预测开始</td></tr><tr><td>日期</td></tr></table>',xtype:"startdatecolumn",dataIndex:"StartDate",menuDisabled:true,sortable:false,width:75},{header:'<table class="head-table"><tr><td>预测完成</td></tr><tr><td>日期</td></tr></table>',xtype:"enddatecolumn",dataIndex:"EndDate",menuDisabled:true,sortable:false,width:75},{header:"<table  ><tr><td>预测</td></tr><tr><td>工时</td></tr></table>",xtype:"workloadcolumn",dataIndex:"WorkLoad",menuDisabled:true,align:"right",sortable:false,width:40,renderer:function(v){return vpGantt.getWLByPrecision(v)}},{header:"前置",width:35,sortable:false,menuDisabled:true,xtype:"dependencytaskcolumn",dataIndex:"DependencyTask"},{header:"%",xtype:"percentdonecolumn",dataIndex:"PercentDone",menuDisabled:true,align:"right",sortable:false,hidden:false,width:40},{header:"资源",menuDisabled:true,sortable:false,width:100,editor:vpGantt.assignmentEditor,xtype:"resourceassigmentcolumn"},{header:"resIds",sortable:false,menuDisabled:true,hidden:false,width:60,dataIndex:"ResIds"},{header:'<table class="head-table"><tr><td>计划开始</td></tr><tr><td>日期</td></tr></table>',xtype:"baselinestartdatecolumn",dataIndex:"BaselineStartDate",menuDisabled:true,sortable:false,width:75},{header:'<table class="head-table"><tr><td>计划完成</td></tr><tr><td>日期</td></tr></table>',xtype:"baselineenddatecolumn",dataIndex:"BaselineEndDate",menuDisabled:true,sortable:false,width:75},{header:'<table class="head-table"><tr><td>计划</td></tr><tr><td>工时</td></tr></table>',xtype:"baselineworkloadcolumn",dataIndex:"BaselineWorkLoad",menuDisabled:true,sortable:false,width:40,renderer:function(b,c,a){if(!Ext.isNumber(b)){return""}b=parseFloat(Ext.Number.toFixed(b,this.decimalPrecision));return'<div style="text-align:right;width:100%;">'+b+"&nbsp;&nbsp;</div>"}},{header:"裁剪",dataIndex:"Option2",menuDisabled:true,hidden:true,sortable:false,width:35}];vpGantt.colSlider=new Ext.create("Ext.slider.Single",{value:Sch.preset.Manager.getPreset("weekAndDayLetter").timeColumnWidth,width:120,minValue:80,maxValue:240,increment:10});vpGantt.showEditingMask=function(){vpGantt.gridMask=new Ext.LoadMask(vpGantt.ganttEl,{msg:"正在编辑数据..."});vpGantt.gridMask.show()};vpGantt.hideEditingMask=function(){vpGantt.gridMask.hide()};vpGantt.getRootNode=function(){if(!this.rootNode){this.rootNode=this.gantt.getTaskStore().getRootNode()}return this.rootNode};vpGantt.rootIsEmpty=function(){var rootNode=this.getRootNode();return rootNode.childNodes.length<1};vpGantt.getAllTasksStr=function(){var rootNode=this.getRootNode(),tasks='{"tasks":[';for(var i=0;i<rootNode.childNodes.length;i++){if(i<1){tasks+=this.getSingleNodeStr(rootNode.childNodes[i])}else{tasks+=","+this.getSingleNodeStr(rootNode.childNodes[i])}}tasks+="]}";tasks=encodeURIComponent(tasks);return tasks};Date.prototype.getFullTime=function(){return this.getFullYear()+"-"+(this.getMonth()>8?(this.getMonth()+1):"0"+(this.getMonth()+1))+"-"+this.getDate()+" "+this.getHours()+":"+this.getMinutes()+":"+this.getSeconds()};Date.prototype.getYMD=function(){return this.getFullYear()+"-"+(this.getMonth()>8?(this.getMonth()+1):"0"+(this.getMonth()+1))+"-"+this.getDate()};vpGantt.trimWLValue=function(v){return this.getWLByPrecision(v)};vpGantt.getSingleNodeStr=function(snode){var curHas=snode.hasChildNodes();var curStr='{"BaselineEndDate":"'+(snode.get("BaselineEndDate")?snode.get("BaselineEndDate").getFullTime():"")+'","Id":"'+snode.get("Id")+'","leaf":'+(!curHas)+',"Name":"'+snode.get("Name").replace(/\"/g,"'")+'","PercentDone":"'+(snode.get("PercentDone")==""?0:snode.get("PercentDone"))+'","StartDate":"'+snode.get("StartDate").getFullTime()+'","EndDate":"'+snode.get("EndDate").getFullTime()+'","Duration":"'+snode.get("Duration")+'","WorkLoad":"'+this.trimWLValue(snode.get("WorkLoad"))+'","BaselineStartDate":"'+(snode.get("BaselineStartDate")?snode.get("BaselineStartDate").getFullTime():"")+'","BaselineDuration":"'+(snode.get("BaselineDuration")||0)+'","BaselineWorkLoad":"'+snode.get("BaselineWorkLoad")+'","DependencyTask":"'+snode.get("DependencyTask")+'","ResIds":"'+snode.get("ResIds")+'","Option2":"'+snode.get("Option2")+'","children":[';for(var i=0;i<snode.childNodes.length;i++){if(i<1){curStr+=this.getSingleNodeStr(snode.childNodes[i])}else{curStr+=","+this.getSingleNodeStr(snode.childNodes[i])}}curStr+="]}";return curStr};vpGantt.addSomeBrotherU=function(thecount){var curcount=thecount,cur=vpGantt.gantt.getSelectionModel().selected.first(),parentNode=cur.parentNode,sdate=vpGantt.getNewStartDate(parentNode);var curEndDate=new Date(sdate.getTime()+(3600*24*1000));while(curcount-->0){var newTask=new Gnt.model.Task({IndicateLight:"{0}{0}{0}{0}",Id:"T_"+vpGantt.newId,PercentDone:0,BaselineWorkLoad:0,WorkLoad:0,Name:"newTask_"+vpGantt.newId++,StartDate:sdate,EndDate:curEndDate,BaselineStartDate:"",BaselineEndDate:"",Duration:1,DurationUnit:"d",leaf:true,Option2:0});parentNode.insertBefore(newTask,cur);newTask.commit()}vpGantt.changeComponent.insertRecords(false,true,thecount);vpGantt.gridMask.hide()};vpGantt.addSomeBrotherD=function(thecount){var curcount=thecount,cur=vpGantt.gantt.getSelectionModel().selected.first(),parentNode=cur.parentNode,sdate=vpGantt.getNewStartDate(parentNode);var curEndDate=new Date(sdate.getTime()+(3600*24*1000));while(curcount-->0){var newTask=new Gnt.model.Task({IndicateLight:"{0}{0}{0}{0}",Id:"T_"+vpGantt.newId,PercentDone:0,BaselineWorkLoad:0,WorkLoad:0,Name:"newTask_"+vpGantt.newId++,StartDate:sdate,EndDate:curEndDate,BaselineStartDate:"",BaselineEndDate:"",Duration:1,DurationUnit:"d",leaf:true,Option2:0});parentNode.insertBefore(newTask,cur.nextSibling);newTask.commit()}vpGantt.changeComponent.insertRecords(false,true,thecount);vpGantt.gridMask.hide()};vpGantt.getNewStartDate=function(parentNode){var today=new Date();if(parentNode&&!parentNode.isRoot()){if(today.getTime()>parentNode.get("StartDate").getTime()){return new Date(today.getFullYear(),today.getMonth(),today.getDate())}else{return parentNode.get("StartDate")}}else{if(today.getTime()>vpGantt.startDate.getTime()&&today.getTime()<vpGantt.endDate.getTime()){return new Date(today.getFullYear(),today.getMonth(),today.getDate())}else{return vpGantt.startDate}}};vpGantt.rootAddChildren=function(thecount){var curdate=vpGantt.getNewStartDate(),curcount=thecount,root=this.gantt.getTaskStore().getRootNode(),curEndDate=new Date(curdate.getTime()+(3600*1000*24));root.set("leaf",false);while(curcount--){var newTask=new Gnt.model.Task({IndicateLight:"{0}{0}{0}{0}",Id:"T_"+vpGantt.newId,BaselineWorkLoad:0,PercentDone:0,Name:"newTask_"+vpGantt.newId++,StartDate:curdate,EndDate:curEndDate,BaselineStartDate:"",BaselineEndDate:"",WorkLoad:0,Duration:1,DurationUnit:"d",leaf:true,Option2:0});newTask.commit();root.appendChild(newTask)}root.expand();vpGantt.changeComponent.insertRecords(false,true,thecount);vpGantt.gridMask.hide()};vpGantt.addChildren=function(thecount){var curcount=thecount,cur=this.gantt.getSelectionModel().selected.first();cur.set("leaf",false);while(curcount--){var newTask=copyTask(cur);newTask.commit();cur.appendChild(newTask)}cur.expand();vpGantt.changeComponent.insertRecords(false,true,thecount);vpGantt.gridMask.hide()};vpGantt.downGrade=function(){var cur=vpGantt.gantt.getSelectionModel().selected.first();if(!cur.previousSibling){alert("当前任务之前没有同级任务,不能对其进行降级!");vpGantt.gridMask.hide();return}else{var preNode=cur.previousSibling;preNode.set("leaf",false);preNode.appendChild(cur);preNode.expand()}if(vpGantt.isDoRollUp()){var curParent=cur.parentNode;while(curParent){if(curParent.childNodes.length>0){var wlNum=0;for(var i=0;i<curParent.childNodes.length;i++){if(curParent.childNodes[i].get("WorkLoad")!=""){}wlNum+=curParent.childNodes[i].get("WorkLoad")}curParent.set({WorkLoad:wlNum})}curParent=curParent.parentNode}}vpGantt.changeComponent.setOtherChanged(true);vpGantt.gridMask.hide()};vpGantt.accessAllNodes=function(node,callObj){callObj.func(node);if(node.childNodes){for(var i=0;i<node.childNodes.length;i++){this.accessAllNodes(node.childNodes[i],callObj)}}};vpGantt.delTask=function(){var cur=vpGantt.gantt.getSelectionModel().selected.first();if(cur.parentNode.childNodes.length==1){cur.parentNode.set("leaf",true)}cur.remove();vpGantt.changeComponent.setOtherChanged(true);vpGantt.gridMask.hide()};vpGantt.upGrade=function(){var cur=vpGantt.gantt.getSelectionModel().selected.first(),hasfellow=cur.nextSibling;var curParent=cur.parentNode;if(curParent.isRoot()){alert("当前任务为顶层任务,不能对其进行升级!");vpGantt.gridMask.hide();return}var cArray=new Array(),nextNode=cur.nextSibling;if(nextNode){var b=new Date(9999,0,0),c=new Date(0),e=cur;while(nextNode){cArray.push(nextNode);if(vpGantt.isDoRollUp()){var f=nextNode;b=Sch.util.Date.min(b,f.get("StartDate")||b);c=Sch.util.Date.max(c,f.get("EndDate")||c)}nextNode=nextNode.nextSibling}if(vpGantt.isDoRollUp()){var sDate=e.get("StartDate").toString(),eDate=e.get("EndDate").toString(),db=b.toString(),dc=c.toString();if(b>c){c=b}if(e.get("StartDate")-b!==0){e.set("StartDate",b)}if(e.get("EndDate")-c!==0){e.set("EndDate",c)}var duration=e.calculateDuration(e.get("StartDate"),e.get("EndDate"),e.get("DurationUnit"));e.set("Duration",duration)}}if(curParent.nextSibling){curParent.parentNode.insertBefore(cur,curParent.nextSibling)}else{curParent.parentNode.appendChild(cur)}if(cArray.length>0){cur.appendChild(cArray);cur.set("leaf",false);cur.expand()}curParent.set("leaf",curParent.childNodes.length<1);if(vpGantt.isDoRollUp()){if(hasfellow){var wlNum=0;for(var i=0;i<cur.childNodes.length;i++){if(cur.childNodes[i].get("WorkLoad")!=""){}wlNum+=cur.childNodes[i].get("WorkLoad")}cur.set({WorkLoad:wlNum})}while(curParent){if(curParent.childNodes.length>0){var wlNum=0;for(var i=0;i<curParent.childNodes.length;i++){if(curParent.childNodes[i].get("WorkLoad")!=""){}wlNum+=curParent.childNodes[i].get("WorkLoad")}curParent.set({WorkLoad:wlNum})}curParent=curParent.parentNode}}vpGantt.changeComponent.setOtherChanged(true);vpGantt.gridMask.hide()};vpGantt.importChildren=function(){var cur=vpGantt.gantt.getSelectionModel().selected.first();if(!cur.get("leaf")){alert("当前节点不是叶子节点,不能对其进行任务导入!");return}var tTaskStore=vpGantt.gantt.getTaskStore();injectNodes2Node(cur,tTaskStore,200);cur.expand()};vpGantt.importProject=function(task,toolbar,pos){if(vpGantt.getTaskId()!="null"){task=true}var title="导入Project文件",height=180,width=400,projectId=vpGantt.getProjectId();if(task){var curTaskId=(toolbar?vpGantt.getTaskId():vpGantt.gantt.getSelectionModel().selected.first().get("Id"));vpGantt.showModalWin("/project/wbs/task/import4ProjectTask.jsp?isTemplate=0&projectID="+projectId+"&taskid="+curTaskId+"&pos="+pos+"&idIsReal="+toolbar,title,height,width)}else{vpGantt.showModalWin("/project/wbs/task/import4Project.jsp?isTemplate=0&projectID="+projectId+"&pos="+pos+"&idIsReal="+toolbar,title,height,width)}};vpGantt.ganttzoom={minValue:40,maxValue:240,increment:10,curValue:Sch.preset.Manager.getPreset("weekAndDayLetter").timeColumnWidth,changeBt:function(){if(vpGantt.ganttzoom.curValue==vpGantt.ganttzoom.maxValue){Ext.getCmp("gantt-zoom-bt").setDisabled(true)}else{if(vpGantt.ganttzoom.curValue==vpGantt.ganttzoom.minValue){Ext.getCmp("gantt-shrink-bt").setDisabled(true)}else{if(vpGantt.ganttzoom.curValue==(vpGantt.ganttzoom.minValue+50)){Ext.getCmp("gantt-shrink-bt").setDisabled(false)}else{if(vpGantt.ganttzoom.curValue==(vpGantt.ganttzoom.maxValue-50)){Ext.getCmp("gantt-zoom-bt").setDisabled(false)}}}}},add:function(){if(vpGantt.ganttzoom.curValue<vpGantt.ganttzoom.maxValue){vpGantt.ganttzoom.curValue+=50;vpGantt.ganttzoom.changeBt();vpGantt.gantt.setTimeColumnWidth(vpGantt.ganttzoom.curValue)}},sub:function(){if(vpGantt.ganttzoom.curValue>vpGantt.ganttzoom.minValue){vpGantt.ganttzoom.curValue-=50;vpGantt.ganttzoom.changeBt();vpGantt.gantt.setTimeColumnWidth(vpGantt.ganttzoom.curValue)}}};vpGantt.afterEWIndecator=1;vpGantt.afterEWClose=function(){if(vpGantt.afterEWIndecator==-1||vpGantt.afterEWIndecator=="-1"){vpGantt.changeComponent.clear();top.open("","_self","");top.close()}else{vpGantt.changeComponent.clear();vpGantt.reloadProject()}};vpGantt.showErrorMsg=function(){if(!vpGantt.genPlanWin){vpGantt.genPlanWin=Ext.create("Ext.Window",{width:450,height:300,modal:true,x:450,y:200,headerPosition:"top",layout:"fit",items:{autoScroll:true,border:0,html:'<div style="width:100%;height:100%;border:0px solid #000;background-color:#ddd;"  ><div id="error-div"></div><div id="error-detail" style="border:0px solid #000;background-color:#ddd;" ></div></div>'},buttons:[{text:"关闭",xtype:"button",handler:function(){vpGantt.afterEWClose()}}],closeAction:"hide",closable:false,bodyBorder:false})}vpGantt.genPlanWin.show()};vpGantt.modalWin;vpGantt.showModalWin=function(src,title,height,width){var width=(width||450),height=(height||300),x=(document.body.clientWidth-width)/2,y=(document.body.clientHeight-height)/2;vpGantt.modalWin=Ext.create("Ext.Window",{width:width,height:height,title:title,modal:true,x:x,y:y-120,headerPosition:"top",layout:"fit",items:{border:0,html:' <iframe src="'+src+'" style="width:100%;height:100%;" name="bottom" scrolling="NO" frameborder="0" noresize>'},closeAction:"destroy",closable:true,bodyBorder:false});vpGantt.modalWin.show();jQuery("#wlt-modalWin").css("display","block")};vpGantt.genPlan=function(type){vpGantt.gridMask=new Ext.LoadMask(vpGantt.ganttEl,{msg:"正在复制数据..."});vpGantt.gridMask.show();setTimeout("vpGantt.genPlanByType("+type+")",10)};vpGantt.showGenPlanWin=function(){if((!(navigator.userAgent.indexOf("chromeframe")>0))&&(!(navigator.userAgent.indexOf("Chrome")>0))){vpGantt.showModalWin("genPlanWindow.jsp","生成任务计划",230)}else{vpGantt.showModalWin("genPlanWindow.jsp","生成任务计划",215)}};vpGantt.saveAllData=function(){jQuery.ajax({url:"/project/wbs/ganttLoadAction.do",data:{projectId:vpGantt.getProjectId(),taskId:vpGantt.getTaskId()=="null"?0:vpGantt.getTaskId(),codetype:"utf8",themethod:"saveTasks",tasks:vpGantt.getAllTasksStr()},type:"post",async:false,success:function(res){if(res.success){vpGantt.changeComponent.clear();vpGantt.reloadProject();return;vpGantt.reload(res.data);vpGantt.changeComponent.clear();vpGantt.disableBt("gantt-save-bt");vpGantt.disableBt("gantt-schedule-bt");vpGantt.enableImport();vpGantt.gridMask.hide()}else{vpGantt.afterEWIndecator=res.failMsgID;vpGantt.gridMask.hide();vpGantt.showErrorMsg();jQuery("#error-div").html(res.failMsg);if(res.items&&res.items.length>0){var detailTab='<table id="error-detail-tab" width="100%"><tr width="30%" class="first-tr"><td width="30%">ID</td><td width="30%">名称</td><td width="30%">前置</td></tr>';for(var i=0,items=res.items;i<items.length;i++){detailTab+='<tr><td colspan=3 style="font-weight:bold;font-size:10px;height:20px;">环路'+(i+1)+"</td></tr>";for(var j=0,inItems=items[i].item;j<inItems.length;j++){detailTab+="<tr><td>"+inItems[j].id+"</td><td>"+inItems[j].name+"</td><td>"+inItems[j].preid+"</td></tr>"}}detailTab+="</table>";jQuery("#error-detail").html(detailTab)}}},dataType:"json"})};vpGantt.colSlider=new Ext.create("Ext.slider.Single",{value:Sch.preset.Manager.getPreset("weekAndDayLetter").timeColumnWidth,width:120,minValue:20,maxValue:240,increment:10});vpGantt.colSlider.on({change:function(slider,value){vpGantt.gantt.setTimeColumnWidth(value,true)},changecomplete:function(slider,value){vpGantt.gantt.setTimeColumnWidth(value)}});vpGantt.dateUnitChange={curUnit:3,unitList:["year","monthAndYear","weekDateAndMonth","weekAndDayLetter"],getCurVP:function(tend){if(tend==="-"){return this.unitList[--this.curUnit]}else{if(tend==="+"){return this.unitList[++this.curUnit]}else{return this.unitList[this.curUnit]}}},add:function(){vpGantt.gantt.switchViewPreset(this.getCurVP("+"),vpGantt.startDate,vpGantt.endDate,true);if(this.curUnit==(this.unitList.length-1)){Ext.getCmp("gantt-zoom-bt").setDisabled(true)}if(this.curUnit==1){Ext.getCmp("gantt-shrink-bt").setDisabled(false)}},sub:function(){vpGantt.gantt.switchViewPreset(this.getCurVP("-"),vpGantt.startDate,vpGantt.endDate,true);if(this.curUnit==0){Ext.getCmp("gantt-shrink-bt").setDisabled(true)}if(this.curUnit==(this.unitList.length-2)){Ext.getCmp("gantt-zoom-bt").setDisabled(false)}}};vpGantt.reloadProject=function(){var url=location.href;url=url.replace("#","");url+="&ctime="+(new Date().getTime());location.href=url};vpGantt.scrollToDate=function(date){try{var sd=Math.round(this.startDate.getTime()/86400000),ed=Math.round(this.endDate.getTime()/86400000),cd=Math.round(date.getTime()/86400000);if(sd<=cd&&cd<=ed){var distance=this.getNormalView().getXYFromDate(date,true)[0],unitNum=4,offsetRight=unitNum*22;var scrollerOwner=this.getNormalView().up("[scrollerOwner]"),hScroller=scrollerOwner.getHorizontalScroller();if(hScroller){hScroller.setScrollLeft(distance>offsetRight?distance-offsetRight:distance)}}}catch(e){}};vpGantt.calendarWin=null;vpGantt.CalendarTitle="项目日历";vpGantt.showCalendar=function(e){var pjID=this.getProjectId();var width=(width||310),height=(height||335),src="/project/wbs/task/pjCalendar.jsp?projectID="+vpGantt.getProjectId()+"&editable="+(this.changeComponent.isChanged()?0:1);vpGantt.calendarWin=Ext.create("Ext.Window",{width:width,height:height,title:vpGantt.CalendarTitle,modal:true,x:e.getX()+100,y:e.getY()+20,headerPosition:"top",layout:"fit",items:{border:0,html:' <iframe src="'+src+'" style="text-align:center;width:100%;height:100%;" name="bottom" scrolling="NO" frameborder="0" noresize>'},closeAction:"destroy",closable:true,bodyBorder:false});vpGantt.calendarWin.show()};vpGantt.closeCalendar=function(){vpGantt.calendarWin.close()};vpGantt.showAddResWin=function(){window.afterselectUsers=function(){var data=window.request.resData;if(data.userID&&data.userID!=""){var ids=(data.userID.split(",")),names=(data.userName.split(",")),sdates=[],edates=[],assigments=[];for(var i=0;i<ids.length;i++){sdates.push(vpGantt.startDate.getYMD());edates.push(vpGantt.endDate.getYMD());assigments.push(100)}jQuery.ajax({url:"/project/wbs/addAppointedResourceAction.do",data:{ajax:"true",projectID:vpGantt.getProjectId(),userID:ids,projectPlanstartdate:sdates,projectPlanenddate:edates,assignmentpercent:assigments,remark2:""},type:"post",async:false,success:function(res){for(var i=0;i<ids.length;i++){vpGantt.addResource(ids[i],names[i],"0")}if(ids.length>0){try{vpGantt.reSortRes();vpGantt.editingGrid.picker.loadTaskAssignments(vpGantt.editingTID)}catch(e){}}},dataType:"json"})}};Search.user({conditionFlag:true,multiple:true})};vpGantt.buttons=(vpGantt.getTaskId()=="null"?[{text:"保存",width:60,iconCls:"gantt-save-bt",disabled:true,id:"gantt-save-bt",handler:function(){vpGantt.gridMask=new Ext.LoadMask(vpGantt.ganttEl,{msg:"正在保存数据..."});vpGantt.gridMask.show();setTimeout("vpGantt.saveAllData()",10)}},{text:"新建",width:60,iconCls:"gantt-new-bt",id:"gantt-new-bt",handler:function(){vpGantt.showEditingMask();setTimeout("vpGantt.rootAddChildren(1)",10)}},{text:"批量新建",width:90,iconCls:"gantt-newsome-bt",id:"gantt-newsome-bt",menu:[{iconCls:"arrow2r",text:"2条任务",handler:function(){vpGantt.showEditingMask();setTimeout("vpGantt.rootAddChildren(2)",10)}},{iconCls:"arrow2r",text:"3条任务",handler:function(){vpGantt.showEditingMask();setTimeout("vpGantt.rootAddChildren(3)",10)}},{iconCls:"arrow2r",text:"5条任务",handler:function(){vpGantt.showEditingMask();setTimeout("vpGantt.rootAddChildren(5)",10)}},{iconCls:"arrow2r",text:"10条任务",handler:function(){vpGantt.showEditingMask();setTimeout("vpGantt.rootAddChildren(10)",10)}}]},{text:"Project导入",iconCls:"gantt-import-bt",id:"gantt-importpj-bt",width:90,handler:function(){setTimeout("vpGantt.importProject(false,true,0)",10)}},{text:"模板导入",iconCls:"gantt-importtp-bt",id:"gantt-importtp-bt",width:75,handler:function(){setTimeout("vpGantt.importTemplate(false,true,0)",10)}},{text:"排程",width:60,iconCls:"gantt-schedule-bt",id:"gantt-schedule-bt",disabled:true,hidden:true,id:"gantt-schedule-bt",handler:function(){vpGantt.gridMask=new Ext.LoadMask(vpGantt.ganttEl,{msg:"正在刷新数据..."});vpGantt.gridMask.show();setTimeout("vpGantt.saveAllData()",10)}},{text:"生成计划时间",iconCls:"gantt-genplan-bt",id:"gantt-genplan-bt",width:100,handler:vpGantt.showGenPlanWin},{text:"虚拟资源管理",iconCls:"gantt-mgvirres-bt",id:"gantt-mgvirres-bt",disabled:false,width:100,handler:function(){vpGantt.virtualResMg()}},{text:"资源替换",iconCls:"gantt-replaceres-bt",id:"gantt-replaceres-bt",disabled:false,width:75,handler:function(){vpGantt.replaceRes()}},{text:"项目日历",iconCls:"gantt-pjcal-bt",id:"gantt-pjcal-bt",disabled:false,width:75,handler:function(bt,e){vpGantt.showCalendar(bt.getEl())}},{text:"放大",iconCls:"gantt-zoom-bt",id:"gantt-zoom-bt",disabled:true,width:60,handler:function(){vpGantt.dateUnitChange.add()}},{text:"缩小",iconCls:"gantt-shrink-bt",id:"gantt-shrink-bt",width:60,disabled:false,handler:function(){vpGantt.dateUnitChange.sub()}},"->",'<div id="_tipsDiv" style="width: 100px;"></div>']:[{text:"保存",width:60,iconCls:"gantt-save-bt",disabled:true,id:"gantt-save-bt",handler:function(){vpGantt.gridMask=new Ext.LoadMask(vpGantt.ganttEl,{msg:"正在保存数据..."});vpGantt.gridMask.show();setTimeout("vpGantt.saveAllData()",10)}},{text:"新建",width:60,iconCls:"gantt-new-bt",id:"gantt-new-bt",handler:function(){vpGantt.showEditingMask();setTimeout("vpGantt.rootAddChildren(1)",10)}},{text:"批量新建",width:90,iconCls:"gantt-newsome-bt",id:"gantt-newsome-bt",menu:[{iconCls:"arrow2r",text:"2条任务",handler:function(){vpGantt.showEditingMask();setTimeout("vpGantt.rootAddChildren(2)",10)}},{iconCls:"arrow2r",text:"3条任务",handler:function(){vpGantt.showEditingMask();setTimeout("vpGantt.rootAddChildren(3)",10)}},{iconCls:"arrow2r",text:"5条任务",handler:function(){vpGantt.showEditingMask();setTimeout("vpGantt.rootAddChildren(5)",10)}},{iconCls:"arrow2r",text:"10条任务",handler:function(){vpGantt.showEditingMask();setTimeout("vpGantt.rootAddChildren(10)",10)}}]},{text:"Project导入",iconCls:"gantt-import-bt",id:"gantt-importpj-bt",width:90,handler:function(){setTimeout("vpGantt.importProject(false,true,0)",10)}},{text:"模板导入",iconCls:"gantt-importtp-bt",id:"gantt-importtp-bt",width:75,handler:function(){setTimeout("vpGantt.importTemplate(false,true,0)",10)}},{text:"排程",width:60,iconCls:"gantt-schedule-bt",id:"gantt-schedule-bt",disabled:true,hidden:true,id:"gantt-schedule-bt",handler:function(){vpGantt.gridMask=new Ext.LoadMask(vpGantt.ganttEl,{msg:"正在刷新数据..."});vpGantt.gridMask.show();setTimeout("vpGantt.saveAllData()",10)}},{text:"生成计划时间",iconCls:"gantt-genplan-bt",id:"gantt-genplan-bt",width:100,handler:vpGantt.showGenPlanWin},{text:"资源替换",iconCls:"gantt-replaceres-bt",id:"gantt-replaceres-bt",disabled:false,width:75,handler:function(){vpGantt.replaceRes()}},{text:"放大",iconCls:"gantt-zoom-bt",id:"gantt-zoom-bt",disabled:true,width:60,handler:function(){vpGantt.dateUnitChange.add()}},{text:"缩小",iconCls:"gantt-shrink-bt",id:"gantt-shrink-bt",width:60,disabled:false,handler:function(){vpGantt.dateUnitChange.sub()}},"->",'<div id="_tipsDiv" style="width: 100px;"></div>']);vpGantt.disableBt=function(bt){if(Ext.getCmp(bt)){Ext.getCmp(bt).setDisabled(true)}};vpGantt.enableBt=function(bt){if(Ext.getCmp(bt)){Ext.getCmp(bt).setDisabled(false)}};vpGantt.setBtText=function(bt,text){if(Ext.getCmp(bt)){Ext.getCmp(bt).setText(text)}};vpGantt.changeComponent={otherChanged:false,changed:false,setChanged:function(val){if(this.changed=val){vpGantt.CalendarTitle="项目日历";vpGantt.setBtText("gantt-pjcal-bt",vpGantt.CalendarTitle)}},getChanged:function(){return this.changed},setOtherChanged:function(){this.otherChanged=arguments[0];this.setChanged(this.otherChanged?true:this.getChanged());if(this.otherChanged){Common.setMenuBeforeClickOpenState(true)}vpGantt.changeComponent.changeSaveAndScheduleBtState()},insertRecords:function(old,add,num){this.setOtherChanged(true)},dragChanged:false,isChanged:function(){return this.otherChanged||this.dragChanged},changeSaveAndScheduleBtState:function(){if(this.isChanged()){vpGantt.enableBt("gantt-save-bt");vpGantt.enableBt("gantt-schedule-bt");vpGantt.disableImport()}else{vpGantt.disableBt("gantt-save-bt");vpGantt.disableBt("gantt-schedule-bt");vpGantt.enableImport()}},normalChange:{isNormalChanged:function(){return(this.records.oldDeleteLength!=0)||(this.records.insertLength!=0)||(this.records.updateLength!=0)},lastChange:null,records:{updateRecords:{},insertLength:0,oldDeleteLength:0,updateLength:0,maxLength:5,addUpdateLength:function(add){if(add){this.updateLength++}else{this.updateLength--}vpGantt.changeComponent.changeSaveAndScheduleBtState()},changeInsertLength:function(old,add,num){old?(add?this.oldDeleteLength+=num:this.oldDeleteLength-=num):(add?this.insertLength+=num:this.insertLength-=num);vpGantt.changeComponent.changeSaveAndScheduleBtState()}},curModified:function(){if(!this.lastChange){return false}else{return this.lastChange.isModified("ResIds")||this.lastChange.isModified("Id")||this.lastChange.isModified("Name")||this.lastChange.isModified("StartDate")||this.lastChange.isModified("EndDate")||this.lastChange.isModified("Duration")||this.lastChange.isModified("DurationUnit")||this.lastChange.isModified("PercentDone")||this.lastChange.isModified("WorkLoad")||this.lastChange.isModified("BaselineStartDate")||this.lastChange.isModified("BaselineEndDate")||this.lastChange.isModified("BaselineDuration")||this.lastChange.isModified("BaselineWorkLoad")||this.lastChange.isModified("DependencyTask")}},setLast:function(cur){this.lastChange=cur;if(this.curModified()){vpGantt.changeComponent.setOtherChanged(true)}else{return}}},dragChange:{sourceNodeId:null,sourceNodeName:null,targetNodeId:null,targetNodeName:null,preParent:null,curParent:null,hangon:false,setParaAndSend:function(src,des,position){this.sourceNodeId=src.get("Id");this.sourceNodeName=src.get("Name");this.targetNodeId=des.get("Id");this.targetNodeName=des.get("Name");if(vpGantt.changeComponent.dragChanged=true){vpGantt.enableBt("gantt-save-bt");vpGantt.enableBt("gantt-schedule-bt");vpGantt.disableImport()}vpGantt.changeComponent.setChanged(vpGantt.changeComponent.dragChanged?true:vpGantt.changeComponent.getChanged());if(vpGantt.changeComponent.dragChanged){Common.setMenuBeforeClickOpenState(true)}this.preParent=src.parentNode;if(position=="apend"){if(this.preParent.get("Id")==des.get("Id")){return}else{this.curParent=this.des}}else{if(position=="after"){if(this.preParent.get("Id")==des.parentNode.get("Id")){return}else{this.curParent=des.parentNode}}else{if(position=="before"){if(this.preParent.get("Id")==des.parentNode.get("Id")){return}else{this.curParent=des.parentNode}}}}this.hangon=true},calcuWorkLoad:function(){if(!this.hangon||!vpGantt.isDoRollUp()){return}var preParent=this.preParent,curParent=this.curParent;var j=1,array=new Array();array.push(preParent);array.push(curParent);while(j>(-1)){var wlNum=0;if(array[j].childNodes&&array[j].childNodes.length>0){for(var i=0;i<array[j].childNodes.length;i++){if(array[j].childNodes[i].get("WorkLoad")!=""){}wlNum+=array[j].childNodes[i].get("WorkLoad")}array[j].set("WorkLoad",wlNum)}j--}preParent=preParent.parentNode,curParent=curParent.parentNode;while(preParent){var wlNum=0;if(preParent.childNodes&&preParent.childNodes.length>0){for(var i=0;i<preParent.childNodes.length;i++){if(preParent.childNodes[i].get("WorkLoad")!=""){}wlNum+=preParent.childNodes[i].get("WorkLoad")}preParent.set("WorkLoad",wlNum)}preParent=preParent.parentNode}while(curParent){var wlNum=0;if(curParent.childNodes&&curParent.childNodes.length>0){for(var i=0;i<curParent.childNodes.length;i++){if(curParent.childNodes[i].get("WorkLoad")!=""){}wlNum+=curParent.childNodes[i].get("WorkLoad")}curParent.set("WorkLoad",wlNum)}curParent=curParent.parentNode}this.preParent=null,this.curParent=null,this.hangon=false}},clear:function(){this.otherChanged=false;this.dragChanged=false;Common.setMenuBeforeClickOpenState(false)}};vpGantt.setStores=function(tStore,store){vpGantt.taskStore=tStore;vpGantt.store=store};vpGantt.editingDependencys=false;vpGantt.setEditingDependencies=function(){this.editingDependencys=arguments[0]};vpGantt.isEditingDependencies=function(){return this.editingDependencys};vpGantt.setDependency=function(from,to,type){this.store.each(function(record){if(record.get("To")===to){this.store.remove(record)}});if(from===""){return}var froms=from.split(",");if(froms.length<1){}else{var noids="",canids="",nocount=0,cancount=0;for(var i=0;i<froms.length;i++){if(!vpGantt.taskStore.getNodeById(froms[i])){if(nocount++!=0){noids+=","+froms[i]}else{noids+=froms[i]}continue}if(this.taskStore.isValidDependency(froms[i],to)){this.store.add(new this.store.model({From:froms[i],To:to,Type:type}));if(cancount++!=0){canids+=","+froms[i]}else{canids+=froms[i]}}else{if(nocount++!=0){noids+=","+froms[i]}else{noids+=froms[i]}}}var curto=vpGantt.taskStore.getNodeById(to);curto.set("DependencyTask",canids);if(nocount>0){alert("任务 "+noids+" 不能被设置为当前任务的前置任务!")}}};Ext.tree.ViewDropZone.override({handleNodeDrop:function(data,targetNode,position){vpGantt.changeComponent.dragChange.setParaAndSend(data.records[0],targetNode,position);var srcParent=data.records[0].parentNode;if(srcParent.childNodes.length==1){srcParent.setValue("leaf",true);srcParent.callStore("afterEdit")}this.callOverridden(arguments)}});Ext.dd.DragSource.override({onDragDrop:function(){this.callOverridden(arguments);vpGantt.changeComponent.dragChange.calcuWorkLoad()}});Ext.dd.DragSource.override({onDragDrop:function(){this.callOverridden(arguments);vpGantt.changeComponent.dragChange.calcuWorkLoad()}});Ext.grid.CellEditor.override({context:null,startEdit:function(c,b,a){this.context=a;this.callOverridden(arguments)},completeEdit:function(a){this.callOverridden(arguments);if(this.context&&this.context.record){vpGantt.changeComponent.normalChange.setLast(this.context.record)}vpGantt.setEditingWorkLoad(false)}});vpGantt.getResIcon=function(ct){return this.iconMap[ct]};vpGantt.genResCls=function(data){this.iconMap={};var ResIcons=data.resIcons;if(!(ResIcons&&ResIcons.length>0)){return}for(var i=0,ri=ResIcons,l=ri.length;i<l;i++){var cur=ri[i];this.iconMap[cur.Type]=cur.Url}};Ext.onReady(function(){vpGantt.buildGantt();vpGantt.createRowMenu()});vpGantt.buildGantt=function(){vpGantt.buildGrid();setTimeout("vpGantt.loadData()",1)};vpGantt.dependencyStorea=new Ext.data.JsonStore({idProperty:"Id",proxy:{type:"memory",reader:{type:"json"}},fields:[{name:"From"},{name:"To"},{name:"Type"}]});vpGantt.dependencyStore=Ext.create("Ext.data.JsonStore",{idProperty:"Id",model:"Gnt.model.Dependency",proxy:{type:"memory",reader:{type:"json"}}});vpGantt.parseDate=function(str){var year=str.substring(0,4),month=str.substring(5,7),day=str.substring(8,10);return new Date(year,(parseInt(month,10)-1),day)};vpGantt.setStateList=function(){this.stateList=arguments[0]};vpGantt.setProgressList=function(){this.progressList=arguments[0]};vpGantt.initUECs=function(res){this.uecmap={};var a=res.uneditcols;if(a){for(var i=0,len=a.length;i<len;i++){this.uecmap[a[i]]=true;var cols=vpGantt.columns;for(var j=0;j<cols.length;j++){var cur=cols[j];if(cur&&cur.dataIndex==a[i]){cur.tdCls="un-edit-col"}}}}};vpGantt.initHiddenBts=function(res){this.hiddenBtMap={};var a=res.hiddenBts;if(a){for(var i=0,len=a.length;i<len;i++){this.hiddenBtMap[a[i]]=true}}};vpGantt.decoBts=function(){var hbts=this.hiddenBtMap;var bts=vpGantt.buttons;if(hbts){for(var i=0,len=bts.length;i<len;i++){var cur=bts[i];if(hbts[cur.id]){cur.hidden=true}}}};vpGantt.initDateScope=function(){jQuery.ajax({url:"/project/wbs/ganttLoadAction.do",data:{themethod:"getProjectInfos",projectId:vpGantt.getProjectId(),taskId:vpGantt.getTaskId()=="null"?0:vpGantt.getTaskId()},type:"post",async:false,success:function(res){vpGantt.initUECs(res);vpGantt.initHiddenBts(res);vpGantt.startDate=vpGantt.parseDate(res.projects?res.projects[0].From:"2011-11-01");vpGantt.endDate=vpGantt.parseDate(res.projects?res.projects[0].To:"2011-11-01");vpGantt.setStateList(res.statlists);vpGantt.setProgressList(res.progresslists);var syscfg=res.syscfg;vpGantt.setHoursPerDay((syscfg&&syscfg.hoursOfday)?parseFloat(syscfg.hoursOfday,10):8);if(!vpGantt.startDate||!vpGantt.endDate||(vpGantt.endDate.getTime()<vpGantt.startDate.getTime())){alert("项目预测开始日期或完成日期异常，请检查项目的基本信息！");vpGantt.gridMask.hide()}if(!res.statlists||!res.progresslists||(res.statlists.length==0)||(res.progresslists.length==0)){alert("系统状态列表或进度状态列表配置异常，请检查！");vpGantt.gridMask.hide()}},dataType:"json"})};vpGantt.buildGrid=function(){vpGantt.initDateScope();vpGantt.decoBts();vpGantt.gantt=Ext.create("Gnt.panel.Gantt",{height:Gantt.height,width:Gantt.width,renderTo:Ext.get(vpGantt.ganttdiv),multiSelect:false,leftLabelField:{dataIndex:"Name",editor:{xtype:"textfield"}},eventRenderer:function(task){if(vpGantt.assignmentStore.findExact("TaskId",task.data.Id)>=0){return{ctcls:"resources-assigned"}}},highlightWeekends:true,showTodayLine:true,loadMask:true,enableDependencyDragDrop:false,enableTaskDragDrop:false,snapToIncrement:true,plugins:Ext.create("Sch.plugin.TreeCellEditing",{clicksToEdit:1}),startDate:vpGantt.startDate,endDate:vpGantt.endDate,viewPreset:"weekAndDayLetter",columns:vpGantt.columns,tbar:vpGantt.buttons,dependencyStore:vpGantt.dependencyStore,resourceStore:vpGantt.resourceStore,assignmentStore:vpGantt.assignmentStore,taskStore:vpGantt.taskStore,stripeRows:true,lockedViewConfig:{plugins:{ptype:"treeviewdragdrop"}},viewConfig:{forceFit:false,getRowClass:function(record,rowIndex,rowParams,store){if(record.data.KeyTask){return"key-path-cls"}}}});vpGantt.bindResize()};vpGantt.getGanttView=function(){return this.gantt.lockedGrid.getView()};vpGantt.getNormalView=function(){return this.gantt.normalGrid.getView()};vpGantt.toggleKeyPath=function(fromRowClick){this.keyPathShow=(!!!this.keyPathShow);var css=document.getElementById("grid-select-css"),show=this.keyPathShow,rootNode=this.getRootNode(),view=this.getGanttView(),nView=this.getNormalView();if(show){css.setAttribute("href","/project/css/gantt-key-path-selected.css")}else{css.setAttribute("href","/project/css/gantt-key-path-normal.css")}};vpGantt.reload=function(data){if(vpGantt.getTaskId()=="null"){this.taskStore.proxy.data=data.tasks}else{if(data.tasks.length<1){this.taskStore.proxy.data=data.tasks}else{this.taskStore.proxy.data=data.tasks[0].children}}this.resourceStore.proxy.data=data.resources;this.assignmentStore.proxy.data=data.assignments;this.dependencyStore.proxy.data=data.dependencies;this.assignmentStore.load();this.resourceStore.load();this.taskStore.load();this.dependencyStore.load();this.gridMask.hide()};vpGantt.loadData=function(){try{var data=vpGantt.getData(vpGantt.getProjectId(),vpGantt.getTaskId()=="null"?0:vpGantt.getTaskId());vpGantt.reload(data);vpGantt.scrollToDate(new Date());vpGantt.genResCls(data);vpGantt.moveAGrid()}catch(e){alert(e.message);vpGantt.gridMask.hide()}};vpGantt.refreshData=function(taskId,pos,idIsReal){vpGantt.modalWinClose();vpGantt.gridMask=new Ext.LoadMask(this.ganttEl,{msg:"正在加载数据..."});vpGantt.gridMask.show();try{vpGantt.loadData()}catch(e){alert(e.message);vpGantt.gridMask.hide()}vpGantt.gridMask.hide();vpGantt.modalWinClose()};vpGantt.inject2Node=function(node,data,pres){this.dependencyStore.loadData(pres.dependencies,true);node.removeAll();node.appendChild(this.getNodesList(this.gantt.getTaskStore(),data))};vpGantt.createRowMenu=function(){vpGantt.rowMenu=Ext.create("Ext.menu.Menu",{id:"rowMenu",items:[{iconCls:"arrow2r",text:"新建同级(上方插入)",handler:function(){vpGantt.showEditingMask();setTimeout("vpGantt.addSomeBrotherU(1)",10)}},{iconCls:"arrow2r",text:"新建同级(下方添加)",handler:function(){vpGantt.showEditingMask();setTimeout("vpGantt.addSomeBrotherD(1)",10)}},{iconCls:"arrow2r",text:"新建下级",handler:function(){vpGantt.showEditingMask();setTimeout("vpGantt.addChildren(1)",10)}},{iconCls:"arrow2r",text:"批量新建同级(上方插入)",menu:{items:[{iconCls:"arrow2r",text:"2条任务",handler:function(){vpGantt.showEditingMask();setTimeout("vpGantt.addSomeBrotherU(2)",10)}},{iconCls:"arrow2r",text:"3条任务",handler:function(){vpGantt.showEditingMask();setTimeout("vpGantt.addSomeBrotherU(3)",10)}},{iconCls:"arrow2r",text:"5条任务",handler:function(){vpGantt.showEditingMask();setTimeout("vpGantt.addSomeBrotherU(5)",10)}},{iconCls:"arrow2r",text:"10条任务",handler:function(){vpGantt.showEditingMask();setTimeout("vpGantt.addSomeBrotherU(10)",10)}}]}},{iconCls:"arrow2r",text:"批量新建同级(下方添加)",menu:{items:[{iconCls:"arrow2r",text:"2条任务",handler:function(){vpGantt.showEditingMask();setTimeout("vpGantt.addSomeBrotherD(2)",10)}},{iconCls:"arrow2r",text:"3条任务",handler:function(){vpGantt.showEditingMask();setTimeout("vpGantt.addSomeBrotherD(3)",10)}},{iconCls:"arrow2r",text:"5条任务",handler:function(){vpGantt.showEditingMask();setTimeout("vpGantt.addSomeBrotherD(5)",10)}},{iconCls:"arrow2r",text:"10条任务",handler:function(){vpGantt.showEditingMask();setTimeout("vpGantt.addSomeBrotherD(10)",10)}}]}},{iconCls:"arrow2r",text:"批量新建下级",menu:{items:[{iconCls:"arrow2r",text:"2条任务",handler:function(){vpGantt.showEditingMask();setTimeout("vpGantt.addChildren(2)",10)}},{iconCls:"arrow2r",text:"3条任务",handler:function(){vpGantt.showEditingMask();setTimeout("vpGantt.addChildren(3)",10)}},{iconCls:"arrow2r",text:"5条任务",handler:function(){vpGantt.showEditingMask();setTimeout("vpGantt.addChildren(5)",10)}},{iconCls:"arrow2r",text:"10条任务",handler:function(){vpGantt.showEditingMask();setTimeout("vpGantt.addChildren(10)",10)}}]}},{iconCls:"arrow2r",text:"删除",handler:function(){vpGantt.showEditingMask();setTimeout("vpGantt.delTask(10)",10)}},"-",{iconCls:"arrow2r",text:"升级",handler:function(){vpGantt.showEditingMask();setTimeout("vpGantt.upGrade()",10)}},{iconCls:"arrow2r",text:"降级",handler:function(){vpGantt.showEditingMask();setTimeout("vpGantt.downGrade()",10)}},"-",{iconCls:"arrow2r",text:"Project导入",menu:{items:[{iconCls:"arrow2r",text:"导入同级(上方插入)",handler:function(){setTimeout("vpGantt.importProject(true,false,2)",10)}},{iconCls:"arrow2r",text:"导入同级(下方添加)",handler:function(){setTimeout("vpGantt.importProject(true,false,1)",10)}},{iconCls:"arrow2r",text:"导入下级",handler:function(){setTimeout("vpGantt.importProject(true,false,0)",10)}}]}},{iconCls:"arrow2r",text:"	WBS模板导入",menu:{items:[{iconCls:"arrow2r",text:"导入同级(上方插入)",handler:function(){setTimeout("vpGantt.importTemplate(true,false,2)",10)}},{iconCls:"arrow2r",text:"导入同级(下方添加)",handler:function(){setTimeout("vpGantt.importTemplate(true,false,1)",10)}},{iconCls:"arrow2r",text:"导入下级",handler:function(){setTimeout("vpGantt.importTemplate(true,false,0)",10)}}]}}]})};vpGantt.getRootNode=function(){if(!this.rootNode){this.rootNode=this.gantt.getTaskStore().getRootNode()}return this.rootNode};vpGantt.rootIsEmpty=function(){var rootNode=this.getRootNode();return rootNode.childNodes.length<1};vpGantt.closeTPPreviewWin=function(){this.closePreviewWin()};vpGantt.closePreviewWin=function(){if(this.TPPreviewWin){this.TPPreviewWin.close()}};vpGantt.showTPPreviewWin=function(pid){var width=document.body.clientWidth,height=document.body.clientHeight,x=(document.body.clientWidth-width)/2,y=(document.body.clientHeight-height)/2,src="/project/wbs/tasktemplate/editTemplate.jsp?preview=1&projectid="+pid;this.TPPreviewWin=Ext.create("Ext.Window",{width:width,height:height,title:" 预览模板",modal:true,x:x,y:0,headerPosition:"top",layout:"fit",items:{border:0,html:'<iframe src="'+src+'" style="text-align:center;width:100%;height:100%;" name="bottom" scrolling="NO" frameborder="0" noresize>'},buttons:[{text:"导入",xtype:"button",handler:function(){vpGantt.doImportTemplate(pid)}},{text:"选择其它模板",xtype:"button",handler:function(){vpGantt.closeTPPreviewWin()}}],closeAction:"destroy",closable:true,bodyBorder:false});this.TPPreviewWin.show()};vpGantt.hideImportTpWin=function(){this.importTpWin.hide()};vpGantt.closeImportTpWin=function(){if(this.importTpWin){this.importTpWin.close()}};vpGantt.showImportTpWin=function(){var width=600,height=300,x=(document.body.clientWidth-width)/2,y=(document.body.clientHeight-height)/2,src="/project/wbs/tasktemplate/templateSelect.jsp?importOpr=1&projectid="+vpGantt.getProjectId();this.importTpWin=Ext.create("Ext.Window",{width:width,height:height,title:"选择导入模板",modal:true,x:x,y:30,headerPosition:"top",layout:"fit",items:{border:0,html:' <iframe src="'+src+'" style="text-align:center;width:100%;height:100%;" name="bottom" scrolling="NO" frameborder="0" noresize>'},closeAction:"destroy",closable:true,bodyBorder:false,draggable:false});this.importTpWin.show()};vpGantt.insertNodes=function(parent,nodes,mark){if(mark){for(var i=0;i<nodes.length;i++){var curTask=nodes[i];parent.insertBefore(curTask,mark);curTask.commit()}}else{parent.set("leaf",false);for(var i=0;i<nodes.length;i++){var curTask=nodes[i];curTask.commit();parent.appendChild(curTask)}parent.expand()}};vpGantt.accessAllJsonNodes=function(node,callObj){callObj.func(node);if(node.children&&node.children.length>0){for(var i=0;i<node.children.length;i++){this.accessAllJsonNodes(node.children[i],callObj)}}};vpGantt.temOldIDCatch=[];vpGantt.decorateForImTT=function(tasks){for(var i=0;i<tasks.length;i++){this.accessAllJsonNodes(tasks[i],{func:function(node){var curId="T_"+vpGantt.newId++;vpGantt.temOldIDCatch[parseInt(node.Id)]=curId;node.Id=curId}})}for(var j=0;j<tasks.length;j++){this.accessAllJsonNodes(tasks[j],{func:function(node){var curDepens=node.DependencyTask;if(curDepens==null||curDepens==""){return}else{var ids=curDepens.split(","),desids="";for(var m=0;m<ids.length;m++){if(m==0){desids+=vpGantt.temOldIDCatch[parseInt(ids[m])]}else{desids+=","+vpGantt.temOldIDCatch[parseInt(ids[m])]}node.DependencyTask=desids}}}})}vpGantt.temOldIDCatch=[]};vpGantt.getTemplateData=function(projectId){var data;jQuery.ajax({url:"/project/wbs/wbstemplateaction.do",data:{themethod:"loadTemplate",projectid:projectId},type:"post",async:false,success:function(res){data=res},dataType:"json"});return data};vpGantt.getTemplateNodes=function(pid){var tasks=this.getTemplateData(pid).tasks,res=[];this.decorateForImTT(tasks);return this.getNodesList(this.gantt.getTaskStore(),tasks)};vpGantt.doImportTemplaterr=function(pid){this.closePreviewWin();this.closeImportTpWin();this.gridMask=new Ext.LoadMask(vpGantt.ganttEl,{msg:"正在编辑数据..."});this.gridMask.show();var nodes=this.getTemplateNodes(pid);if(nodes.length>0){curTask=vpGantt.gantt.getSelectionModel().selected.first();if(this.imTTPara.task){if(this.imTTPara.pos=="0"){if(curTask.childNodes.length<1){this.insertNodes(curTask,nodes)}else{this.insertNodes(curTask,nodes,curTask.childNodes[0])}}else{if(this.imTTPara.pos=="1"){this.insertNodes(curTask.parentNode,nodes,curTask.nextSibling)}else{this.insertNodes(curTask.parentNode,nodes,curTask)}}}else{var rootNode=this.getRootNode();rootNode.removeAll();this.insertNodes(rootNode,nodes)}vpGantt.changeComponent.setOtherChanged(true)}else{alert("导入模板为空!")}this.gridMask.hide()};vpGantt.doImportTemplate=function(pid){this.closePreviewWin();this.closeImportTpWin();this.gridMask=new Ext.LoadMask(vpGantt.ganttEl,{msg:"正在编辑数据..."});jQuery.ajax({url:"/project/wbs/wbstemplateaction.do",data:{themethod:"importTemplate",projectid:vpGantt.getProjectId(),templateid:pid,isFromTemplate:false,isTask:vpGantt.imTTPara.task,pos:vpGantt.imTTPara.pos,taskid:(vpGantt.imTTPara.task?(vpGantt.imTTPara.toolbar?vpGantt.getTaskId():vpGantt.gantt.getSelectionModel().selected.first().get("Id")):0),idIsReal:(vpGantt.imTTPara.task&&vpGantt.imTTPara.toolbar)},type:"post",async:false,success:function(res){vpGantt.reloadProject()},dataType:"json"});this.gridMask.hide()};vpGantt.importTemplate=function(task,toolbar,pos){if(vpGantt.getTaskId()!="null"){task=true}vpGantt.imTTPara={task:task,toolbar:toolbar,pos:pos};if((!this.rootIsEmpty())&&toolbar){Ext.MessageBox.confirm("导入位置提示","WBS计划模板将会导入在当前任务计划的最后（根节点处）。<br/>如需在在某个任务节点处导入，请通过节点下拉操作处理！<br/><br/>请确认是否继续？",function(bt){if(bt=="yes"){vpGantt.showImportTpWin()}})}else{vpGantt.showImportTpWin()}};vpGantt.disableImport=function(){vpGantt.disableBt("gantt-importpj-bt");vpGantt.disableBt("gantt-importtp-bt");vpGantt.disableBt("gantt-mgvirres-bt");vpGantt.disableBt("gantt-replaceres-bt");vpGantt.disableRowMenuItem(11);vpGantt.disableRowMenuItem(12)};vpGantt.enableImport=function(){vpGantt.enableBt("gantt-importpj-bt");vpGantt.enableBt("gantt-importtp-bt");vpGantt.enableBt("gantt-mgvirres-bt");vpGantt.enableBt("gantt-replaceres-bt");vpGantt.enableRowMenuItem(11);vpGantt.enableRowMenuItem(12)};vpGantt.disableRowMenuItem=function(index){vpGantt.rowMenu.items.getAt(index).disable()};vpGantt.enableRowMenuItem=function(index){vpGantt.rowMenu.items.getAt(index).enable()};vpGantt.genPlanByType=function(type){var rootNode=this.getRootNode();type=(type=="0"?type:(type=="1"?"2":"all"));vpGantt.accessAllNodes(rootNode,{type:type,func:function(snode){if(snode.isRoot()){return}if(snode.get("IndicateLight").charAt(1)==this.type||this.type=="all"){snode.setValue({BaselineStartDate:snode.get("StartDate"),BaselineEndDate:snode.get("EndDate")?(snode.get("Duration")==0?snode.get("EndDate"):new Date(snode.get("EndDate").getTime()-1)):"",BaselineWorkLoad:snode.get("WorkLoad")});snode.callStore("afterEdit")}}});vpGantt.changeComponent.setOtherChanged(true);vpGantt.gridMask.hide();vpGantt.modalWinClose()};vpGantt.modalWinClose=function(){if(vpGantt.modalWin){vpGantt.modalWin.close()}};vpGantt.hoursPerDay=8;vpGantt.setHoursPerDay=function(num){vpGantt.hoursPerDay=num};vpGantt.calcuWorkLoad=function(record){var added,workload=record.get("WorkLoad"),duration=0,resNum=0,res,persent=0;if(record.get("ResIds")==""||record.get("Duration")==""||record.get("Duration")==0){resNum=0;duration=0}else{res=record.get("ResIds").split(",");duration=record.get("Duration");for(var i=0;i<res.length;i++){persent+=(parseFloat(res[i].split("#")[1],10)/100)}}nowvalue=persent*vpGantt.hoursPerDay*duration;nowvalue=vpGantt.getWLByPrecision(nowvalue);record.setValue({WorkLoad:nowvalue});record.callStore("afterEdit");if(!vpGantt.isDoRollUp()){return}var curp=record.parentNode;while(curp&&!curp.isRoot()){var pDuration=0;for(var i=0;i<curp.childNodes.length;i++){var cd=curp.childNodes[i].data.WorkLoad;pDuration+=(cd==""?0:cd)}curp.set({WorkLoad:pDuration});curp=curp.parentNode}};this.editingWorkLoad=false;vpGantt.isEditingWorkLoad=function(){return this.editingWorkLoad};vpGantt.setEditingWorkLoad=function(bl){this.editingWorkLoad=bl};vpGantt.bindResize=function(){vpGantt.preWidth=document.body.clientWidth;if(window.addEventListener){window.addEventListener("resize",function(){if(document.body.clientWidth<vpGantt.preWidth){vpGantt.gantt.setWidth(document.body.clientWidth+17)}else{vpGantt.gantt.setWidth(document.body.clientWidth)}vpGantt.gantt.setHeight(document.body.clientHeight);vpGantt.preWidth=document.body.clientWidth},false)}else{window.attachEvent("onresize",function(){vpGantt.gantt.setWidth(document.body.clientWidth);vpGantt.gantt.setHeight(document.body.clientHeight)})}};vpGantt.newResId=100;vpGantt.addResourceReserved=function(id,name){var exsist=false;this.resourceStore.each(function(item){if(parseInt(id)==parseInt(item.get("Id"))){exsist=true;return false}});if(!exsist){this.resourceStore.add({Id:id,Name:name})}vpGantt.moveAGrid()};vpGantt.addResource=function(id,name,type){var exsist=false,idsArray=[],i=0;this.resourceStore.each(function(item){if(parseInt(id)==parseInt(item.get("Id"))){exsist=true;vpGantt.resourceStore.add({Id:id,Name:name,Units:100,IconType:type||-1});vpGantt.resourceStore.remove(item);return false}});if(!exsist){this.resourceStore.add({Id:id,Name:name,Units:100,IconType:type})}};Ext.Error.raise=function(err){err=err||{};if(Ext.isString(err)){err={msg:err}}var method=this.raise.caller;if(method){if(method.$name){err.sourceMethod=method.$name}if(method.$owner){err.sourceClass=method.$owner.$className}}if(Ext.Error.handle(err)!==true){var msg=Ext.Error.prototype.toString.call(err);Ext.log({msg:msg,level:"error",dump:err,stack:true})}};vpGantt.virtualResMg=function(){Common.showModalWin("/project/wbs/virtualResourceAction.do?wbs=wbs&event=getResource&projectID="+vpGantt.getProjectId(),window,660,500,function(obj){if(obj){vpGantt.reloadProject()}})};vpGantt.closeReplaceWin=function(refresh){this.replaceResWin.close();if(refresh){vpGantt.reloadProject()}};vpGantt.showResReplaceWin=function(){var url="/project/wbs/virtualResourceAction.do?wbs=wbs&event=getResType&projectID="+vpGantt.getProjectId();var width=450,height=320,x=(document.body.clientWidth-width)/2,y=(document.body.clientHeight-height)/2,src="";this.replaceResWin=Ext.create("Ext.Window",{width:width,height:height,title:"资源替换",modal:true,x:x,y:30,headerPosition:"top",layout:"fit",items:{border:0,html:'<iframe src="'+url+'" style="text-align:center;width:100%;height:100%;" name="bottom" scrolling="NO" frameborder="0" noresize>'},closeAction:"destroy",closable:true,bodyBorder:false});this.replaceResWin.show()};vpGantt.replaceRes=function(){vpGantt.showResReplaceWin()};vpGantt.reSortRes=function(){vpGantt.editingGrid.resourceStore.sort([{property:"IconType",direction:"ASC"}])};vpGantt.addVirtualRes=function(){Common.showModalWin("/project/wbs/virtualResourceAction.do?wbs=wbs&event=getResource&add=res&projectID="+vpGantt.getProjectId(),window,385,290,function(obj){if(obj&&obj.id&&obj.name){vpGantt.addResource(obj.id,obj.name,1);try{vpGantt.reSortRes();vpGantt.editingGrid.picker.loadTaskAssignments(vpGantt.editingTID)}catch(e){}}})};vpGantt.getResGridBts=function(){return['<div id="res-bt1" class="add-res-div" ><a href="#" onclick="vpGantt.showAddResWin()">+资源</a>','<div id="res-bt2" class="add-res-div" ><a href="#" onclick="vpGantt.addVirtualRes()">+虚拟资源</a>']};vpGantt.withChrome=function(){return(navigator.userAgent.toLowerCase().indexOf("chrome")>-1)};vpGantt.moveAGrid=function(){var css=document.getElementById("grid-assigngrid-css");if((!this.withChrome())&&this.resourceStore.getCount()>4){css.setAttribute("href","/project/css/gnt-asgrid-move.css")}else{css.setAttribute("href","")}};vpGantt.getUECMap=function(){return this.uecmap||{}}}catch(e){alert(e.message);vpGantt.gridMask.hide()};